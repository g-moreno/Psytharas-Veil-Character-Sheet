<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Into the Psythara Veil â€” Character Creator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
  <style>
    /* Starry Background */
    body {
      background-color: #0d0f1c;
      font-family: 'Orbitron', sans-serif;
      color: #9efff4;
      text-shadow: 0 0 5px rgba(158, 255, 244, 0.5);
      position: relative;
      overflow-y: scroll;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(ellipse at 15% 25%, #4a236d 10%, transparent 40%),
        radial-gradient(ellipse at 85% 75%, #2a3a8c 20%, transparent 50%),
        radial-gradient(circle at 60% 40%, #7d33a3 5%, transparent 15%),
        radial-gradient(ellipse at 40% 60%, #3a7591 15%, transparent 45%),
        radial-gradient(ellipse at 70% 30%, #a4539e 10%, transparent 30%),
        radial-gradient(ellipse at 20% 80%, #1e3f5a 15%, transparent 40%);
      z-index: -2;
    }

    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
      background: transparent;
    }

    .star {
      position: absolute;
      background: white;
      border-radius: 50%;
      opacity: 0;
      animation: twinkle linear infinite;
    }

    /* Core Styles */
    :root {
      --panel-bg: rgba(20, 25, 45, 0.8);
      --border-color: #9efff4;
      --text-color: #e0fff4;
      --accent-color: #9efff4;
      --muted-color: #a0c0b0;
      --input-bg: rgba(10, 15, 30, 0.9);
      --input-border: 1px solid #9efff4;
      --button-bg: linear-gradient(180deg, #9efff4, #50d0a0);
      --button-border: 1px solid #308060;
      --button-text: #0c0f1c;
      --danger-bg: #ff6b6b;
      --ok-bg: #7ed957;
      --positive-color: #7ed957;
      --negative-color: #ff6b6b;
      --zero-color: #a0c0b0;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; }
    h1, h2, h3 { margin: 0 0 0.5rem; color: var(--accent-color); }
    h1 { font-size: 1.8rem; text-transform: uppercase; }
    h2 { font-size: 1.3rem; }
    h3 { font-size: 1.1rem; color: var(--muted-color); }

    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .grid { display: grid; gap: 14px; }
    .cols { grid-template-columns: repeat(12, 1fr); }
    .panel {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 0 15px rgba(158, 255, 244, 0.2);
    }

    label { display: block; font-weight: 600; color: var(--muted-color); margin-bottom: 4px; }
    input[type="text"], input[type="number"], select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 4px;
      border: var(--input-border);
      background: var(--input-bg);
      color: var(--text-color);
      outline: none;
      font-family: 'Orbitron', sans-serif;
    }
    input[type="number"] { appearance: textfield; }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { appearance: none; margin: 0; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .kv { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .pill {
      display: inline-block;
      padding: .15rem .5rem;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      color: var(--accent-color);
      font-size: .8rem;
      margin-right: .25rem;
      text-transform: uppercase;
    }
    .btn {
      background: var(--button-bg);
      border: var(--button-border);
      color: var(--button-text);
      padding: 10px 14px;
      border-radius: 4px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      font-family: 'Orbitron', sans-serif;
      transition: background 0.2s ease;
    }
    .btn:hover { background: linear-gradient(180deg, #50d0a0, #9efff4); }
    .btn.secondary { background: #37406d; border-color: #2e365f; color: #e0fff4; }
    .btn.secondary:hover { background: #454d7d; }
    .btn.danger { background: var(--danger-bg); border-color: #9f2f41; color: white; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    .statbox { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
    .stat {
      background: var(--input-bg);
      border: var(--input-border);
      border-radius: 4px;
      padding: 10px;
      text-align: center;
    }
    .stat h3 { margin-bottom: 6px; color: var(--accent-color); }
    .mono { font-family: 'Orbitron', sans-serif; color: var(--accent-color); }
    .muted { color: var(--muted-color); }
    .divider { height: 1px; background: var(--border-color); margin: 10px 0 14px; opacity: 0.5; }
    
    details { border: 1px dashed var(--border-color); padding: 10px; border-radius: 4px; }
    details > summary { cursor: pointer; color: var(--accent-color); }
    details > summary:hover { text-decoration: underline; }
    .subgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .flex { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .chip {
      padding: .2rem .5rem;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: var(--input-bg);
      color: var(--muted-color);
      font-size: .78rem;
    }
    .two { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .three { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .four { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    code.inline {
      background: var(--input-bg);
      border: var(--input-border);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Orbitron', sans-serif;
      color: var(--accent-color);
    }
    .notice { font-size: .9rem; color: #a0c0b0; }
    footer { opacity: .75; margin-top: 20px; font-size: 0.9rem; }
    
    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--panel-bg); }
    ::-webkit-scrollbar-thumb {
      background: #9efff4;
      border-radius: 4px;
      border: 1px solid #0c0f1c;
    }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    /* New styles for Dice Roller and Point Buy */
    .dice-container {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .dice-container .dice-btn {
      width: 60px;
      height: 60px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      border: var(--button-border);
      background: var(--panel-bg);
      color: var(--accent-color);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .dice-container .dice-btn:hover {
      background: var(--input-bg);
      box-shadow: 0 0 10px var(--accent-color);
    }
    .dice-container .selected-die {
      background: var(--button-bg);
      color: var(--button-text);
      box-shadow: 0 0 10px var(--accent-color);
    }
    .dice-result {
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      margin-top: 10px;
      min-height: 40px;
      color: var(--accent-color);
    }
    .dice-options {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 10px;
    }
    .dice-options .btn {
      padding: 5px 10px;
      width: auto;
    }
    .rolling-die {
      animation: rolling 1s linear infinite;
    }
    @keyframes rolling {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .stat-cost-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .stat-cost {
      background: var(--input-bg);
      border: var(--input-border);
      border-radius: 4px;
      padding: 8px;
      text-align: center;
    }
    .stat-cost input[type="number"] {
      text-align: center;
      width: 100%;
      -moz-appearance: textfield;
      appearance: textfield;
    }
    .stat-cost-controls {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 5px;
    }
    .stat-cost-controls button {
      width: 25px;
      height: 25px;
      padding: 0;
      font-size: 1.2rem;
    }
    .positive-mod { color: var(--positive-color); }
    .negative-mod { color: var(--negative-color); }
    .zero-mod { color: var(--zero-color); }
    .points-left {
      text-align: center;
      font-weight: bold;
      margin-top: 10px;
    }
    .points-error { color: var(--negative-color); }

    /* Profile pic styles */
    .profile-pic-container {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .profile-pic-frame {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      overflow: hidden;
      border: 5px solid;
      box-shadow: 0 0 10px;
      transition: all 0.3s ease;
      background-size: cover;
      background-position: center;
    }
    .profile-pic-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .profile-pic-input {
      display: none;
    }
    .name-input-large {
      flex-grow: 1;
    }
    .name-input-large h2 {
      margin-bottom: 0.25rem;
    }

    /* Class-specific border patterns and colors */
    /* Tanks: Hex grid */
    .border-juggernaut, .border-soldier, .border-sentinel, .border-survivor {
      border-color: #a0a8b4;
      box-shadow: 0 0 10px #a0a8b4;
      background-image: linear-gradient(45deg, #a0a8b4 25%, transparent 25%),
                        linear-gradient(-45deg, #a0a8b4 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #a0a8b4 75%),
                        linear-gradient(-45deg, transparent 75%, #a0a8b4 75%);
      background-size: 10px 10px;
      background-position: 0 0, 0 5px, 5px -5px, 5px 0;
    }
    /* Melee DPS: Energy wave */
    .border-starseer, .border-omniform, .border-monsterhunter, .border-beasttamer {
      border-color: #ffb6c1;
      box-shadow: 0 0 10px #ffb6c1;
      background-image: radial-gradient(circle, #ffb6c1 10%, transparent 10%),
                        radial-gradient(circle, transparent 90%, #ffb6c1 90%);
      background-size: 20px 20px;
      background-position: 0 0;
      animation: energy-wave 2s linear infinite;
    }
    @keyframes energy-wave {
      from { background-position: 0 0; }
      to { background-position: 40px 40px; }
    }
    /* Ranged DPS & Rogues: Circuit board */
    .border-bountyhunter, .border-smuggler, .border-specter, .border-gadgeteer {
      border-color: #6a5acd;
      box-shadow: 0 0 10px #6a5acd;
      background-image: repeating-linear-gradient(45deg, #6a5acd 0, #6a5acd 1px, transparent 1px, transparent 5px);
    }
    /* Casters/Support: Stars */
    .border-warpmage, .border-psion, .border-technomancer, .border-medic, .border-luminar, .border-harmonist, .border-scientist, .border-politician {
      border-color: #00ffff;
      box-shadow: 0 0 10px #00ffff;
      background-image: radial-gradient(circle at 10% 20%, #00ffff 1px, transparent 1px),
                        radial-gradient(circle at 90% 80%, #00ffff 1px, transparent 1px),
                        radial-gradient(circle at 40% 60%, #00ffff 1px, transparent 1px);
      background-size: 200% 200%;
      animation: star-field 5s linear infinite;
    }
    @keyframes star-field {
      from { background-position: 0 0; }
      to { background-position: -200% -200%; }
    }

    /* Final Stats styling */
    .final-stats-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .final-stat-chip {
      padding: 0.5rem;
      border-radius: 4px;
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      text-align: center;
    }
    .final-stat-chip h3 {
      margin: 0;
      font-size: 1rem;
      color: var(--muted-color);
    }
    .final-stat-chip span {
      font-size: 1.5rem;
      color: var(--accent-color);
    }
    hr {
      border: 0;
      height: 1px;
      background: var(--border-color);
      margin: 10px 0;
      opacity: 0.5;
    }
    .dice-results {
      text-align: center;
      margin-top: 10px;
      font-size: 1.5rem;
      min-height: 40px;
    }
    .dice-results .result-roll {
      display: inline-block;
      margin: 0 5px;
      padding: 5px;
      border-radius: 4px;
    }
    .dice-results .highlight-result {
      color: var(--positive-color);
      font-weight: bold;
    }
    .dice-results .lowlight-result {
      color: var(--negative-color);
      opacity: 0.7;
    }
    .dice-roll-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="stars" id="stars-container"></div>
  <div class="wrap grid cols" id="app">
    <div class="panel" style="grid-column: span 12">
      <h1>Into the Psythara Veil â€” Character Creator</h1>
      <div class="muted">Level 1â€“5 quickbuilder â€¢ Uses rules from your uploaded Player/Class/Species/Armor guides. Toggle named-armor vs formula AC, auto-calc HP by class role, and export your sheet.</div>
    </div>

    <div class="panel" style="grid-column: span 6">
      <h2>// Identity</h2>
      <div class="profile-pic-container">
        <div class="profile-pic-frame" id="profile-pic-frame">
          <img id="profile-pic-preview" src="" alt="Character Profile Picture">
        </div>
        <div class="name-input-large">
          <label>Character Name</label>
          <input id="name" type="text" placeholder="e.g., Kessa Vox" />
          <hr />
          <div class="flex" style="justify-content: space-between;">
            <div>
              <label>Level</label>
              <input id="level" type="number" min="1" max="5" value="1" style="width: 80px;" />
            </div>
            <label for="profile-pic-input" class="btn secondary" style="align-self: flex-end;">Upload Pic</label>
            <input type="file" id="profile-pic-input" accept="image/*" class="profile-pic-input">
          </div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Species</label>
          <select id="species"></select>
        </div>
        <div>
          <label>Class</label>
          <select id="clazz"></select>
        </div>
      </div>
      <div class="divider"></div>
      <div class="kv"><div>Role</div><div class="mono" id="role">â€“</div></div>
      <div class="kv"><div>Starting HP</div><div class="mono" id="startingHP">â€“</div></div>
      <div class="kv"><div>HP / Level (by role)</div><div class="mono" id="hpPerLevel">â€“</div></div>
      <div class="kv"><div>Total HP @ Level</div><div class="mono" id="totalHP">â€“</div></div>
      <div class="kv"><div>Focus Points</div><div class="mono" id="focus">2</div></div>
      <div class="notice">Focus: 2 at level 1; spend to reuse specials this combat, add +1d4 after seeing a roll, or pop to 1 HP once per combat.</div>
    </div>

    <div class="panel" style="grid-column: span 6">
      <h2>// Attributes (Point Buy)</h2>
      <div class="muted">Start with 27 points. All stats begin at 8. Cost increases for higher scores.</div>
      <div class="points-left" id="points-left">Points Left: 27</div>
      <div class="divider"></div>
      <div class="stat-cost-grid" id="stats">
        </div>
      <div id="speciesBonusUI" style="margin-top:10px"></div>
      <div class="divider"></div>
      <button class="btn" id="lock-stats-btn" onclick="toggleLockStats()">Lock Stats</button>
      <div class="divider"></div>
      <div class="final-stats-container">
        <div class="final-stat-chip"><h3>STR</h3><span class="mono" id="STR_final">â€“</span></div>
        <div class="final-stat-chip"><h3>AGI(DEX)</h3><span class="mono" id="AGI_final">â€“</span></div>
        <div class="final-stat-chip"><h3>CON</h3><span class="mono" id="CON_final">â€“</span></div>
        <div class="final-stat-chip"><h3>INT</h3><span class="mono" id="INT_final">â€“</span></div>
        <div class="final-stat-chip"><h3>WIS</h3><span class="mono" id="WIS_final">â€“</span></div>
        <div class="final-stat-chip"><h3>CHA</h3><span class="mono" id="CHA_final">â€“</span></div>
      </div>
    </div>

    <div class="panel" style="grid-column: span 7">
      <h2>// Loadout</h2>
      <div class="two">
        <div>
          <label>Starter Weapon</label>
          <select id="weapon"></select>
          <div class="muted" id="weaponInfo"></div>
        </div>
        <div>
          <label>Armor</label>
          <select id="armor"></select>
          <div class="muted" id="armorInfo"></div>
        </div>
      </div>
      <div class="two" style="margin-top:10px">
        <div>
          <label><input type="checkbox" id="toggleNamedArmor" checked /> Use Named Armor stats (AC 12â€“15, special perks)</label>
        </div>
        <div>
          <label><input type="checkbox" id="hasShield" /> Using a shield (+1 AC)</label>
        </div>
      </div>
      <div class="divider"></div>
      <div class="three">
        <div class="kv"><div>Armor Type</div><div class="mono" id="armorType">â€“</div></div>
        <div class="kv"><div>AC (calculated)</div><div class="mono" id="ac">â€“</div></div>
        <div class="kv"><div>Notes</div><div class="mono" id="acNotes">â€“</div></div>
      </div>
    </div>

    <div class="panel" style="grid-column: span 5">
      <h2>// Features</h2>
      <div class="three">
        <div>
          <label>Utility A</label>
          <select id="utilA"></select>
        </div>
        <div>
          <label>Utility B</label>
          <select id="utilB"></select>
        </div>
        <div>
          <label>Special (from weapon)</label>
          <div class="mono" id="specialName">â€“</div>
        </div>
      </div>
      <div class="divider"></div>
      <details>
        <summary>Special & Utilities</summary>
        <div id="featureText" class="muted" style="margin-top:8px"></div>
      </details>
    </div>

    <div class="panel" style="grid-column: span 12">
      <h2>// Dice Roller</h2>
      <div class="dice-container">
        <button class="dice-btn selected-die" data-sides="4">D4</button>
        <button class="dice-btn" data-sides="6">D6</button>
        <button class="dice-btn" data-sides="8">D8</button>
        <button class="dice-btn" data-sides="10">D10</button>
        <button class="dice-btn" data-sides="12">D12</button>
        <button class="dice-btn" data-sides="20">D20</button>
        <button class="dice-btn" data-sides="100">D100</button>
      </div>
      <div class="dice-roll-controls">
        <label>Rolls:</label>
        <input type="number" id="num-rolls" value="1" min="1" max="10" style="width:60px;" />
        <button class="btn secondary" id="btn-adv" onclick="toggleAdv(this)">Advantage</button>
        <button class="btn secondary" id="btn-dis" onclick="toggleDis(this)">Disadvantage</button>
        <button class="btn" id="roll-button">Roll Dice</button>
      </div>
      <div class="dice-results" id="dice-results"></div>
    </div>

    <div class="panel" style="grid-column: span 12">
      <h2>// Export / Print</h2>
      <div class="flex">
        <button class="btn" id="btnExport">Export JSON</button>
        <button class="btn secondary" id="btnPrint">Print Sheet</button>
        <div class="muted">Your selections are saved to localStorage automatically.</div>
      </div>
    </div>

    <div class="panel" style="grid-column: span 12">
      <h2>// Sheet Preview</h2>
      <div class="four">
        <div>
          <h3>Identity</h3>
          <div id="pv_identity" class="muted"></div>
        </div>
        <div>
          <h3>Defenses</h3>
          <div id="pv_def" class="muted"></div>
        </div>
        <div>
          <h3>Offense</h3>
          <div id="pv_off" class="muted"></div>
        </div>
        <div>
          <h3>Features</h3>
          <div id="pv_feat" class="muted"></div>
        </div>
      </div>
    </div>

    <footer class="muted" style="grid-column: span 12">
      Built for your homebrew packets. Rules referenced: starting HP by role, Focus, armor & AC (Light/Medium/Heavy/Shield), named armor options per class, species bonuses. Toggle formula vs named armor to fit your table.
    </footer>
  </div>

  <script>
    const diceIcons = {
      '4': 'D4',
      '6': 'D6',
      '8': 'D8',
      '10': 'D10',
      '12': 'D12',
      '20': 'D20',
      '100': 'D100'
    };

    // Star generator script
    const starsContainer = document.getElementById('stars-container');
    const numStars = 100;

    for (let i = 0; i < numStars; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      star.style.width = star.style.height = `${Math.random() * 3 + 1}px`;
      star.style.left = `${Math.random() * 100}%`;
      star.style.top = `${Math.random() * 100}%`;
      star.style.animationDuration = `${Math.random() * 2 + 1}s`;
      star.style.animationDelay = `${Math.random() * 2}s`;
      starsContainer.appendChild(star);
    }
    
    const ROLES = {
      "Tank": {hpPerLevel: 7},
      "Balanced Frontline": {hpPerLevel: 7},
      "Anti-Supernatural Defender": {hpPerLevel: 7},
      "Melee DPS": {hpPerLevel: 6},
      "Mystic Warrior": {hpPerLevel: 6},
      "Shapeshifter": {hpPerLevel: 6},
      "Anti-Creature Specialist": {hpPerLevel: 6},
      "Companion Striker": {hpPerLevel: 6},
      "Ranged DPS": {hpPerLevel: 5},
      "Charisma Rogue": {hpPerLevel: 5},
      "Intel Specialist": {hpPerLevel: 5},
      "Versatile Striker": {hpPerLevel: 5},
      "Mobility Caster": {hpPerLevel: 5},
      "Mental Controller": {hpPerLevel: 5},
      "Hybrid Tech-Mage": {hpPerLevel: 5},
      "Pure Healer": {hpPerLevel: 5},
      "Spiritual-Tech Healer": {hpPerLevel: 5},
      "Buff/Debuff Healer": {hpPerLevel: 5},
      "Support/Utility": {hpPerLevel: 5},
      "Social Control": {hpPerLevel: 5},
      "Industrial Combatant": {hpPerLevel: 6},
    };

    const CLASSES = [
      { key:"Juggernaut", role:"Tank", startHP:14,
        weapons:[
          {name:"Titan Maul", dmg:"1d10+3", type:"Melee", special:{name:"Shockwave Slam", text:"Cone knockdown (once/short rest)."}},
          {name:"Bulwark Shield", dmg:"1d8+3", type:"Melee", special:{name:"Fortress Wall", text:"+2 AC to self & allies within 5 ft for 1 round."}}
        ],
        armor:[
          {name:"Bulwark Plate", type:"Heavy", ac:15, perk:"Disadvantage on Stealth; ignore knockback once/short rest."},
          {name:"Reinforced Vest", type:"Medium", ac:14, perk:"Reduce first damage each combat by 2."}
        ],
        utils:["Bodyguard â€” React to take damage for ally.", "Adrenal Surge â€” Temp HP = level + CON mod (1/rest)."]
      },
      { key:"Soldier", role:"Balanced Frontline", startHP:14,
        weapons:[
          {name:"Assault Rifle", dmg:"1d8+3", type:"Ranged", special:{name:"Suppressing Fire", text:"Target has disadvantage on attacks for 1 round."}},
          {name:"Combat Knife", dmg:"1d6+3", type:"Melee", special:{name:"Bleeding Strike", text:"1d4 bleed for 2 rounds."}}
        ],
        armor:[
          {name:"Combat Armor", type:"Medium", ac:14, perk:"+1 save vs Frightened."},
          {name:"Field Vest", type:"Light", ac:13, perk:"+5 ft movement."}
        ],
        utils:["Tactical Reload â€” Bonus reload, +2 AC.", "Battle Focus â€” +1d4 to next attack or save."]
      },
      { key:"Sentinel", role:"Anti-Supernatural Defender", startHP:14,
        weapons:[
          {name:"Null Blade", dmg:"1d8+3", type:"Melee", special:{name:"Phase Cut", text:"+1d6 dmg vs extraplanar."}},
          {name:"Ward Staff", dmg:"1d6+3", type:"Melee", special:{name:"Barrier Field", text:"+2 AC to all allies within 10 ft for 1 round."}}
        ],
        armor:[
          {name:"Warden Plate", type:"Heavy", ac:15, perk:"Advantage on saves vs magic (1/short rest)."},
          {name:"Sigil Guard", type:"Medium", ac:14, perk:"+1 AC vs extraplanar foes."}
        ],
        utils:["Warding Sigil â€” Prevent planar travel (area).", "Purging Strike â€” Remove one magical effect on hit."]
      },
      { key:"Starseer", role:"Mystic Warrior", startHP:12,
        weapons:[
          {name:"Photon Saber", dmg:"1d8+3", type:"Melee", special:{name:"Blinding Slash", text:"Dazes target (once/short rest)."}},
          {name:"Psionic Blade", dmg:"1d6+3 (psychic)", type:"Melee", special:{name:"Mind Pierce", text:"Ignores armor."}}
        ],
        armor:[
          {name:"Photon Guard", type:"Medium", ac:14, perk:"Advantage on initiative."},
          {name:"Psionic Weave", type:"Light", ac:13, perk:"+1 to Wisdom saves."}
        ],
        utils:["Foresight â€” Force enemy to reroll an attack.", "Deflect Strike â€” Reduce ranged dmg by 1d8 + AGI."]
      },
      { key:"Omniform", role:"Shapeshifter", startHP:12,
        weapons:[
          {name:"Adaptive Claws", dmg:"1d8+3", type:"Melee", special:{name:"Morph Bite", text:"Heal 1d6 on hit."}},
          {name:"Morph Whip", dmg:"1d6+3", type:"Melee", special:{name:"Morph Pull", text:"Pull target 10 ft."}}
        ],
        armor:[
          {name:"Morphhide Armor", type:"Medium", ac:14, perk:"Gain resistance to one damage type for 1 round (1/rest)."},
          {name:"Flexweave Suit", type:"Light", ac:13, perk:"+5 ft movement."}
        ],
        utils:["Quick Morph â€” Change form as bonus action.", "Mimic Physique â€” Copy physical stat bonuses for 1 min."]
      },
      { key:"Monster Hunter", role:"Anti-Creature Specialist", startHP:12,
        weapons:[
          {name:"Harpoon Gun", dmg:"1d8+3", type:"Ranged", special:{name:"Reel In", text:"Pull Large or smaller."}},
          {name:"Beast Cleaver", dmg:"1d10+3", type:"Melee", special:{name:"Rend", text:"+1d6 vs beasts."}}
        ],
        armor:[
          {name:"Trackerâ€™s Mail", type:"Medium", ac:14, perk:"+2 to Survival checks."},
          {name:"Beastward Vest", type:"Light", ac:13, perk:"Advantage vs beast fear."}
        ],
        utils:["Hunterâ€™s Mark â€” +1d4 dmg to tracked target.", "Beast Lore â€” Identify creature traits instantly."]
      },
      { key:"Beast Tamer", role:"Companion Striker", startHP:12,
        weapons:[
          {name:"Tamerâ€™s Spear", dmg:"1d8+3", type:"Melee", special:{name:"Beast Rally", text:"Companion attacks immediately."}},
          {name:"Whip", dmg:"1d6+3", type:"Melee", special:{name:"Disarm", text:"Strip weapon or impose - to next attack."}}
        ],
        armor:[
          {name:"Companion Guard", type:"Medium", ac:14, perk:"Companion gains +1 AC."},
          {name:"Tamerâ€™s Wraps", type:"Light", ac:13, perk:"Advantage on Animal Handling."}
        ],
        utils:["Command Beast â€” Bonus action direct companion.", "Bonded Recovery â€” Heal companion 1d6 (1/rest)."]
      },
      { key:"Bounty Hunter", role:"Ranged DPS", startHP:11,
        weapons:[
          {name:"Pulse Rifle", dmg:"1d10+3", type:"Ranged", special:{name:"Mark Target", text:"Allies get +2 to hit the target."}},
          {name:"Dual Blasters", dmg:"2Ã—(1d6+3)", type:"Ranged", special:{name:"Rapid Barrage", text:"Nova fire; once/short rest (Focus to reuse)."}}
        ],
        armor:[
          {name:"Hunterâ€™s Rig", type:"Medium", ac:14, perk:"+1 to ranged attack rolls for 1 round (1/rest)."},
          {name:"Pursuerâ€™s Vest", type:"Light", ac:13, perk:"+10 ft when chasing marked target."}
        ],
        utils:["Trackerâ€™s Instinct â€” Advantage on Survival tracking.", "Target Lock â€” +4 to hit once/rest."]
      },
      { key:"Smuggler", role:"Charisma Rogue", startHP:11,
        weapons:[
          {name:"Hidden Blaster", dmg:"1d8+3", type:"Ranged", special:{name:"Surprise Shot", text:"+2d6 if unseen."}},
          {name:"Vibroblade", dmg:"1d6+3", type:"Melee", special:{name:"Quick Stab", text:"Bonus action attack."}}
        ],
        armor:[
          {name:"Concealed Armor", type:"Light", ac:13, perk:"Advantage on Sleight of Hand."},
          {name:"Street Leathers", type:"Light", ac:12, perk:"+1 AC in urban environments."}
        ],
        utils:["Silver Tongue â€” Adv. on Persuasion (1/rest).", "Escape Artist â€” Disengage as bonus action."]
      },
      { key:"Specter", role:"Intel Specialist", startHP:11,
        weapons:[
          {name:"Scout Rifle", dmg:"1d8+3", type:"Ranged", special:{name:"Spotterâ€™s Mark", text:"Ally crit range +1 vs target."}},
          {name:"Silenced Pistol", dmg:"1d6+3", type:"Ranged", special:{name:"Quiet Kill", text:"No alert on kill."}}
        ],
        armor:[
          {name:"Shadow Weave", type:"Light", ac:13, perk:"Advantage on Stealth."},
          {name:"Recon Suit", type:"Light", ac:12, perk:"Ignore difficult terrain 1 round (1/rest)."}
        ],
        utils:["Recon Sweep â€” Reveal hidden foes (30 ft).", "Data Tap â€” Hack a basic system in 1 round."]
      },
      { key:"Gadgeteer", role:"Versatile Striker", startHP:11,
        weapons:[
          {name:"Shock Gauntlet", dmg:"1d8+3", type:"Melee", special:{name:"EMP Burst", text:"Disable tech in 10 ft."}},
          {name:"Mini-Turret", dmg:"1d6 per turn (3r)", type:"Deployable", special:{name:"Deploy Turret", text:"Deals 1d6/turn for 3 turns."}}
        ],
        armor:[
          {name:"Tech Armor", type:"Medium", ac:14, perk:"+1 AC vs ranged attacks."},
          {name:"Light Mech-Suit", type:"Light", ac:13, perk:"+1 STR for lifting/carrying."}
        ],
        utils:["Grapple Hook â€” Pull self/ally 20 ft.", "Overcharge â€” +1d6 to next tech attack."]
      },
      { key:"Warp Mage", role:"Mobility Caster", startHP:10,
        weapons:[
          {name:"Warp Staff", dmg:"1d6+3", type:"Melee", special:{name:"Blink Step", text:"Teleport 20 ft."}},
          {name:"Gravity Orb", dmg:"1d8+3", type:"Ranged", special:{name:"Gravity Well", text:"Pull enemies 10 ft."}}
        ],
        armor:[
          {name:"Phasewrap", type:"Light", ac:13, perk:"Teleport 10 ft when hit (1/rest)."},
          {name:"Gravity Vest", type:"Light", ac:12, perk:"+1 CON saves."}
        ],
        utils:["Phase Shift â€” Halve damage from one attack.", "Time Dilation â€” Ally +10 ft move."]
      },
      { key:"Psion", role:"Mental Controller", startHP:10,
        weapons:[
          {name:"Mind Spike", dmg:"1d8+3 (psychic)", type:"Ranged", special:{name:"Confuse", text:"Target attacks its ally."}},
          {name:"Psi Blade", dmg:"1d6+3", type:"Melee", special:{name:"Mind Drain", text:"+1d6 dmg and heal same amount."}}
        ],
        armor:[
          {name:"Mindward Robes", type:"Light", ac:13, perk:"+1 to saves vs mental effects."},
          {name:"Focus Garb", type:"Light", ac:12, perk:"+1 to initiative."}
        ],
        utils:["Mental Shield â€” Ally +2 save vs mental.", "Suggestion â€” Briefly command weak-willed foe."]
      },
      { key:"Technomancer", role:"Hybrid Tech-Mage", startHP:10,
        weapons:[
          {name:"Arc Caster", dmg:"1d8+3", type:"Ranged", special:{name:"Chain Lightning", text:"Jumps to a second target."}},
          {name:"Techblade", dmg:"1d8+3", type:"Melee", special:{name:"Energy Slash", text:"+1d6 energy damage."}}
        ],
        armor:[
          {name:"Arc Mesh", type:"Medium", ac:14, perk:"Resist lightning once/rest."},
          {name:"Runed Suit", type:"Light", ac:13, perk:"+1 to spell attack rolls."}
        ],
        utils:["Overload â€” Boost next attack (+1d4 dmg).", "Shield Pulse â€” Ally +2 AC for 1 round."]
      },
      { key:"Medic", role:"Pure Healer", startHP:10,
        weapons:[
          {name:"Medi-Pistol", dmg:"â€”", type:"Ranged Healer", special:{name:"Stim Shot", text:"Grant +10 ft movement."}},
          {name:"Surgical Blade", dmg:"1d6+3", type:"Melee", special:{name:"Field Surgery", text:"Heal 2d4."}}
        ],
        armor:[
          {name:"Field Medic Vest", type:"Light", ac:13, perk:"+1 to Medicine checks."},
          {name:"Responder Gear", type:"Light", ac:12, perk:"+5 ft movement."}
        ],
        utils:["Triage â€” Heal as bonus action.", "Adrenal Boost â€” Ally advantage on next roll."]
      },
      { key:"Luminar", role:"Spiritual-Tech Healer", startHP:10,
        weapons:[
          {name:"Radiant Focus", dmg:"â€”", type:"Healer", special:{name:"Radiant Infusion", text:"Heals; details per GM packet."}},
          {name:"Lightstaff", dmg:"1d6+3", type:"Melee", special:{name:"Lumen Ward", text:"+2 AC to ally for 1 round."}}
        ],
        armor:[
          {name:"Radiant Guard", type:"Light", ac:13, perk:"Resist radiant once/rest."},
          {name:"Lightweave Robes", type:"Light", ac:12, perk:"+1 Wisdom saves."}
        ],
        utils:["Channel Light â€” Minor heal.", "Sanctify â€” Buff vs darkness (table-specific)."]
      },
      { key:"Harmonist", role:"Buff/Debuff Healer", startHP:10,
        weapons:[
          {name:"Resonance Bow", dmg:"1d8+3", type:"Ranged", special:{name:"Inspire", text:"Ally gains +2 AC."}},
          {name:"Discord Blade", dmg:"1d6+3", type:"Melee", special:{name:"Weaken", text:"Target -2 dmg."}}
        ],
        armor:[
          {name:"Resonant Armor", type:"Light", ac:13, perk:"+1 to allies' saves within 5 ft (1/rest)."},
          {name:"Melody Cloth", type:"Light", ac:12, perk:"Advantage on Persuasion."}
        ],
        utils:["Harmonic Shield â€” Allies +1 to saves.", "Dissonance â€” Enemy disadvantage on next attack."]
      },
      { key:"Scientist", role:"Support/Utility", startHP:10,
        weapons:[
          {name:"Analyzer Drone", dmg:"â€”", type:"Support", special:{name:"Weakpoint Mark", text:"Allies +1d6 dmg vs target."}},
          {name:"Chem Dispenser", dmg:"â€”", type:"Control", special:{name:"Cloud", text:"Create smoke/acid cloud."}}
        ],
        armor:[
          {name:"Lab Harness", type:"Light", ac:13, perk:"+1 Investigation."},
          {name:"Field Research Suit", type:"Light", ac:12, perk:"Resist poison once/rest."}
        ],
        utils:["Scan â€” Learn enemy HP/resistances.", "Mix Compound â€” Create minor buff/debuff."]
      },
      { key:"Politician", role:"Social Control", startHP:10,
        weapons:[
          {name:"Ceremonial Blade", dmg:"1d6+3", type:"Melee", special:{name:"Command", text:"Force target to act."}},
          {name:"Diplomatâ€™s Pistol", dmg:"1d8+3", type:"Ranged", special:{name:"Disarm Hostility", text:"One enemy canâ€™t attack you."}}
        ],
        armor:[
          {name:"Diplomatâ€™s Coat", type:"Light", ac:13, perk:"Advantage on Insight."},
          {name:"Ceremonial Guard Vest", type:"Light", ac:12, perk:"+1 AC during formal events."}
        ],
        utils:["Speechcraft â€” Inspire (+1d4).", "Blackmail â€” Extract information."]
      },
      { key:"Survivor Engineer", role:"Industrial Combatant", startHP:12,
        weapons:[
          {name:"Plasma Cutter", dmg:"1d8+3", type:"Melee", special:{name:"Armor Melt", text:"-2 AC on target for 1 round."}},
          {name:"Hydraulic Hammer", dmg:"1d10+3", type:"Melee", special:{name:"Concussive Slam", text:"Stun target."}}
        ],
        armor:[
          {name:"Hazard Plate", type:"Medium", ac:14, perk:"Resist fire once/rest."},
          {name:"Workmanâ€™s Vest", type:"Light", ac:13, perk:"+1 STR on tool checks."}
        ],
        utils:["Emergency Repair â€” Heal mech ally 1d8+INT.", "Hazard Foam â€” Create difficult terrain."]
      }
    ];

    const SPECIES = [
      {key:"Human", bonuses:{any:["Any","Any"], amt:[1,1]}, naturalArmor:null, note:"Versatility â€” 1/long rest, advantage on any skill check."},
      {key:"Lombax", bonuses:{DEX:2, INT:1}, naturalArmor:null, note:"Tinkerâ€™s Ingenuity â€” 1/long rest, +2 to AC or attacks for 1 round."},
      {key:"Virellian", bonuses:{CON:2, WIS:1}, naturalArmor:null, note:"Aquatic Mastery â€” Swim; heal 1d6 in water (1/long rest)."},
      {key:"Drakari", bonuses:{STR:2, CON:1}, naturalArmor:{base:13, uses:"DEX"}, note:"Scaly Resilience â€” Natural AC 13 + Dex; 1/long rest halve incoming dmg."},
      {key:"Auralis", bonuses:{INT:2, CHA:1}, naturalArmor:null, note:"Energy Surge â€” 1/short rest +1d6 energy dmg on an attack."},
      {key:"Thrynn", bonuses:{DEX:2}, naturalArmor:null, note:"Skybound â€” Glide; 1/long rest dash w/o OAs."},
      {key:"Synthborn", bonuses:{CON:2, INT:1}, naturalArmor:null, note:"Systems Override â€” Auto-succeed save vs poison/disease/mind control once/long rest."},
      {key:"Myrrid", bonuses:{WIS:2, CON:1}, naturalArmor:null, note:"Regrowth â€” Heal level + WIS mod once/long rest."},
      {key:"Grey", bonuses:{INT:2, WIS:1}, naturalArmor:null, note:"Mind Probe â€” Read surface thoughts once/long rest."},
      {key:"Symbiote", bonuses:{choice2:["STR","DEX"], CON:1}, naturalArmor:null, note:"Symbiotic Surge â€” 1/long rest, advantage on all attack rolls for 1 round; take 1d4 damage after."}
    ];

    const BASE_STATS = ["STR","AGI","CON","INT","WIS","CHA"];
    const STAT_COSTS = {8:0, 9:1, 10:2, 11:3, 12:4, 13:5, 14:7, 15:9};

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    
    function abilityMod(score) {
      const mod = Math.floor((Number(score||0)-10)/2);
      const span = document.createElement('span');
      span.textContent = `${mod > 0 ? '+' : ''}${mod}`;
      if (mod > 0) span.className = 'positive-mod';
      else if (mod < 0) span.className = 'negative-mod';
      else span.className = 'zero-mod';
      return span;
    }

    function fillSelect(el, arr, getLabel=x=>x, getValue=x=>x){
      el.innerHTML = arr.map(x=>`<option value="${getValue(x)}">${getLabel(x)}</option>`).join("");
    }

    function getClass(key){return CLASSES.find(c=>c.key===key)}
    function getSpecies(key){return SPECIES.find(s=>s.key===key)}

    function renderSpeciesBonusUI(species){
      const wrap = $('#speciesBonusUI');
      if(!wrap) return;
      const b = species.bonuses||{};
      let html = '';
      const saved = JSON.parse(localStorage.getItem('psythara_char')||'{}');
      const sc = (saved && saved.speciesChoices) ? saved.speciesChoices : {};
      if(b.any){
        html += `<div class="subgrid">
          <div>
            <label>Human +1 Bonus #1</label>
            <select id="any1">${BASE_STATS.map(s=>`<option ${(sc.any1||'STR')===s?'selected':''} value="${s}">${s}</option>`).join('')}</select>
          </div>
          <div>
            <label>Human +1 Bonus #2</label>
            <select id="any2">${BASE_STATS.map(s=>`<option ${(sc.any2||'INT')===s?'selected':''} value="${s}">${s}</option>`).join('')}</select>
          </div>
        </div>`;
      }
      if(b.choice2){
        const opts = ['STR','AGI'];
        html += `<div style="margin-top:8px">
          <label>Symbiote +2 Choice</label>
          <select id="choice2">${opts.map(s=>`<option ${(sc.choice2||'STR')===s?'selected':''} value="${s}">${s}</option>`).join('')}</select>
        </div>`;
      }
      if(html){
        wrap.innerHTML = `<h3>Species Stat Bonuses</h3>${html}`;
        ['any1','any2','choice2'].forEach(id=>{ const el = $(`#${id}`); if(el) el.addEventListener('change', updateAll); });
      } else {
        wrap.innerHTML = '';
      }
    }

    function save(){
      const data = collect();
      localStorage.setItem('psythara_char', JSON.stringify(data));
    }

    function load(){
      const raw = localStorage.getItem('psythara_char');
      if(!raw) {
        initPointBuy();
        updateAll();
        return;
      }
      const d = JSON.parse(raw);
      $('#name').value = d.name||'';
      $('#level').value = d.level||1;
      $('#species').value = d.species||SPECIES[0].key;
      $('#clazz').value = d.clazz||CLASSES[0].key;
      $('#toggleNamedArmor').checked = d.useNamedArmor ?? true;
      $('#hasShield').checked = !!d.hasShield;
      if (d.baseStats) {
        BASE_STATS.forEach(k=>{
          $(`#stat_${k}`).value = d.baseStats[k];
        });
      } else {
        initPointBuy();
      }
      
      if (d.profilePic) {
          $('#profile-pic-preview').src = d.profilePic;
          $('#profile-pic-preview').style.display = 'block';
          $('#profile-pic-frame').style.backgroundImage = 'none';
      }
      
      if (d.lockedStats) {
        isLocked = true;
        toggleLockStats(true);
      }
      updateAll();
    }

    function initPointBuy() {
      BASE_STATS.forEach(k => {
        $(`#stat_${k}`).value = 8;
      });
    }

    function collect(){
      const sp = $('#species').value;
      const cl = $('#clazz').value;
      const data = {
        name: $('#name').value,
        level: Number($('#level').value||1),
        species: sp,
        clazz: cl,
        weapon: $('#weapon').value,
        armor: $('#armor').value,
        utilA: $('#utilA').value,
        utilB: $('#utilB').value,
        useNamedArmor: $('#toggleNamedArmor').checked,
        hasShield: $('#hasShield').checked,
        baseStats: Object.fromEntries(BASE_STATS.map(k=>[k, Number($(`#stat_${k}`).value||0)])),
        profilePic: $('#profile-pic-preview').src,
        lockedStats: isLocked,
      };
      data.speciesChoices = {
        any1: document.querySelector('#any1')?.value || null,
        any2: document.querySelector('#any2')?.value || null,
        choice2: document.querySelector('#choice2')?.value || null,
      };
      return data;
    }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(collect(), null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${($('#name').value||'character').replace(/\s+/g,'_')}.json`;
      document.body.appendChild(a); a.click(); a.remove();
    }
    
    let isLocked = false;
    function toggleLockStats(forceLock = false) {
      if (!forceLock) {
        isLocked = !isLocked;
      }
      const lockBtn = $('#lock-stats-btn');
      lockBtn.textContent = isLocked ? 'Unlock Stats' : 'Lock Stats';
      $$('.stat-cost input, .stat-cost-controls button').forEach(el => {
        el.disabled = isLocked;
      });
      updateAll();
    }

    const getPointCost = (score) => {
      if (score >= 8 && score <= 13) return score - 8;
      if (score === 14) return 7;
      if (score === 15) return 9;
      return 0;
    }

    function updateStat(statKey, change) {
      if(isLocked) return;
      const statInput = $(`#stat_${statKey}`);
      let score = Number(statInput.value) + change;
      if (score < 8) score = 8;
      if (score > 15) score = 15;
      
      const currentCost = getPointCost(Number(statInput.value));
      const newCost = getPointCost(score);
      
      let pointsSpent = 0;
      BASE_STATS.forEach(k => {
        pointsSpent += getPointCost(Number($(`#stat_${k}`).value));
      });

      pointsSpent -= currentCost;
      pointsSpent += newCost;

      if(pointsSpent > 27){
        return;
      }
      
      statInput.value = score;
      updateAll();
    }

    function applySpeciesBonuses(base, species){
      const out = {...base};
      const b = species.bonuses||{};
      Object.entries(b).forEach(([k,v])=>{
        if(k==='any' || k==='choice2') return;
        if(out[k] !== undefined) out[k] += v;
      });
      const any1 = document.querySelector('#any1')?.value;
      const any2 = document.querySelector('#any2')?.value;
      const choice2 = document.querySelector('#choice2')?.value;
      if(b.any){
        if(any1) out[any1] = (out[any1]||0) + 1;
        if(any2) out[any2] = (out[any2]||0) + 1;
      }
      if(b.choice2){
        const pick = choice2 || 'STR';
        out[pick] = (out[pick]||0) + 2;
      }
      return out;
    }

    function calcAC(data, species, clazz, useNamed){
      const agiMod = Math.floor((data.finalStats.AGI-10)/2);
      let armor = clazz.armor.find(a=>a.name===data.armor) || clazz.armor[0];
      let notes = [];
      let ac = 10;
      let armType = armor?.type || 'â€”';

      if(useNamed && armor){
        ac = armor.ac;
        notes.push(armor.perk);
      } else {
        if(armType==='Light') ac = 12 + agiMod;
        else if(armType==='Medium') ac = 14 + Math.min(2, Math.max(0, agiMod));
        else if(armType==='Heavy') ac = 16;
      }

      if(species.naturalArmor && species.naturalArmor.base){
        const nat = species.naturalArmor.base + (species.naturalArmor.uses==='DEX'?agiMod:0);
        if(nat>ac){
          notes.push(`Natural armor active (${nat})`);
          ac = nat; armType = 'Natural';
        }
      }

      if($('#hasShield').checked) ac += 1;
      return {ac, notes: notes.filter(Boolean).join(' '), armType};
    }
    
    function updateProfilePicBorder(classKey) {
        const picFrame = $('#profile-pic-frame');
        picFrame.classList.remove(...picFrame.classList);
        picFrame.classList.add('profile-pic-frame');

        let borderClass = 'border-caster'; // Default to a caster/support border

        if (['juggernaut', 'soldier', 'sentinel', 'survivorengineer'].includes(classKey)) {
          borderClass = 'border-juggernaut';
        } else if (['starseer', 'omniform', 'monsterhunter', 'beasttamer'].includes(classKey)) {
          borderClass = 'border-starseer';
        } else if (['bountyhunter', 'smuggler', 'specter', 'gadgeteer'].includes(classKey)) {
          borderClass = 'border-bountyhunter';
        } else if (['warpmage', 'psion', 'technomancer', 'medic', 'luminar', 'harmonist', 'scientist', 'politician'].includes(classKey)) {
          borderClass = 'border-warpmage';
        }

        picFrame.classList.add(borderClass);
    }
    
    function updateAll(){
      const data = collect();
      const clazz = getClass(data.clazz) || CLASSES[0];
      const species = getSpecies(data.species) || SPECIES[0];

      renderSpeciesBonusUI(species);

      fillSelect($('#weapon'), clazz.weapons, w=>`${w.name} â€” ${w.type} (${w.dmg})`, w=>w.name);
      fillSelect($('#armor'), clazz.armor, a=>`${a.name} â€” ${a.type} (AC ${a.ac})`, a=>a.name);
      fillSelect($('#utilA'), clazz.utils||[], u=>u, u=>u);
      fillSelect($('#utilB'), clazz.utils||[], u=>u, u=>u);

      if(data.weapon) $('#weapon').value = data.weapon;
      if(data.armor) $('#armor').value = data.armor;
      if(data.utilA) $('#utilA').value = data.utilA;
      if(data.utilB) $('#utilB').value = data.utilB;
      
      let pointsSpent = 0;
      BASE_STATS.forEach(k => {
        pointsSpent += getPointCost(Number($(`#stat_${k}`).value));
      });
      const pointsLeft = 27 - pointsSpent;
      const pointsLeftEl = $('#points-left');
      pointsLeftEl.textContent = `Points Left: ${pointsLeft}`;
      if (pointsLeft < 0) {
        pointsLeftEl.classList.add('points-error');
      } else {
        pointsLeftEl.classList.remove('points-error');
      }
      
      $$('.stat-cost-controls button').forEach(el => {
        el.disabled = isLocked;
      });

      const base = Object.fromEntries(BASE_STATS.map(k=>[k, Number($(`#stat_${k}`).value||0)]));
      const finalStats = applySpeciesBonuses({...base}, species);
      data.finalStats = finalStats;

      BASE_STATS.forEach(k=>{
        const modEl = $(`#mod_${k}`);
        modEl.innerHTML = '';
        modEl.appendChild(abilityMod(finalStats[k]));
        $(`#${k}_final`).textContent = finalStats[k];
      })

      const lvl = Math.max(1, Math.min(5, Number($('#level').value||1)));
      const role = clazz.role;
      const hpPer = (ROLES[role]?.hpPerLevel) || 5;
      const conMod = Math.floor((finalStats.CON-10)/2);
      const startHPFinal = clazz.startHP + conMod;
      const perLevelFinal = hpPer + conMod;
      const totalHP = startHPFinal + (lvl-1)*perLevelFinal;

      $('#role').textContent = role;
      $('#startingHP').textContent = `${clazz.startHP} + CON (${conMod>=0?'+':''}${conMod}) = ${startHPFinal}`;
      $('#hpPerLevel').textContent = `${hpPer} + CON (${conMod>=0?'+':''}${conMod}) = ${perLevelFinal}`;
      $('#totalHP').textContent = totalHP;

      const w = clazz.weapons.find(x=>x.name === $('#weapon').value) || clazz.weapons[0];
      $('#weaponInfo').textContent = w ? `${w.type} â€¢ ${w.dmg} â€¢ Special: ${w.special.name}` : 'â€”';
      $('#specialName').textContent = w ? w.special.name : 'â€”';

      const a = clazz.armor.find(x=>x.name === $('#armor').value) || clazz.armor[0];
      $('#armorInfo').textContent = a ? `${a.type} â€¢ AC ${a.ac} â€¢ ${a.perk}` : 'â€”';
      const {ac, notes, armType} = calcAC(data, species, clazz, $('#toggleNamedArmor').checked);
      $('#ac').textContent = ac;
      $('#acNotes').textContent = notes || 'â€”';
      $('#armorType').textContent = armType;
      
      updateProfilePicBorder(clazz.key.toLowerCase().replace(/\s/g, ''));

      const uA = $('#utilA').value;
      const uB = $('#utilB').value;
      const featureTextEl = $('#featureText');
      featureTextEl.innerHTML = ``;
      if (species.note) {
          featureTextEl.innerHTML += `<b>Species:</b> ${species.note} <br>`;
      }
      if (w && w.special) {
          featureTextEl.innerHTML += `<b>Weapon Special:</b> ${w.special.name} â€” ${w.special.text} <br>`;
      }
      if (uA) {
          featureTextEl.innerHTML += `<b>Utility A:</b> ${uA} <br>`;
      }
      if (uB) {
          featureTextEl.innerHTML += `<b>Utility B:</b> ${uB} <br>`;
      }
      if (!featureTextEl.innerHTML) {
          featureTextEl.textContent = 'â€”';
      }

      $('#pv_identity').innerHTML = `
        <div><span class="pill">${$('#name').value||'Unnamed'}</span> <span class="pill">Lvl ${lvl}</span></div>
        <div><span class="pill">${species.key}</span> <span class="pill">${clazz.key}</span></div>
      `;
      $('#pv_def').innerHTML = `
        <div><span class="pill">HP ${totalHP}</span> <span class="pill">AC ${ac}</span> <span class="pill">Focus 2</span></div>
        <div class="muted">${notes||''}</div>
        <div class="muted">HP: start ${clazz.startHP}+${Math.floor((finalStats.CON-10)/2)}, per lvl ${hpPer}+${Math.floor((finalStats.CON-10)/2)}</div>
      `;
      $('#pv_off').innerHTML = `
        <div><span class="pill">Weapon</span> <span class="pill">${w?.name||'â€”'}</span></div>
        <div class="muted">${w? `${w.type} â€¢ ${w.dmg}`:'â€”'}</div>
      `;
      $('#pv_feat').innerHTML = featureTextEl.innerHTML;
      
      save();
    }
    
    let selectedDice = 20;
    let advantage = false;
    let disadvantage = false;

    $$('.dice-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedDice = parseInt(btn.dataset.sides);
        $$('.dice-btn').forEach(b => b.classList.remove('selected-die'));
        btn.classList.add('selected-die');
      });
    });

    function toggleAdv(el) {
      advantage = !advantage;
      disadvantage = false;
      el.classList.toggle('secondary', !advantage);
      $('#btn-dis').classList.add('secondary');
    }

    function toggleDis(el) {
      disadvantage = !disadvantage;
      advantage = false;
      el.classList.toggle('secondary', !disadvantage);
      $('#btn-adv').classList.add('secondary');
    }
    
    $('#roll-button').addEventListener('click', () => {
      const numRolls = parseInt($('#num-rolls').value) || 1;
      const resultsEl = $('#dice-results');
      resultsEl.innerHTML = '';
      
      const rollingDie = document.createElement('span');
      rollingDie.textContent = diceIcons[selectedDice];
      rollingDie.classList.add('rolling-die');
      resultsEl.appendChild(rollingDie);

      setTimeout(() => {
        resultsEl.innerHTML = '';
        for(let i = 0; i < numRolls; i++) {
          let roll1, roll2;
          let finalResult;
          let output = '';

          if (selectedDice === 20 && (advantage || disadvantage)) {
            roll1 = Math.floor(Math.random() * selectedDice) + 1;
            roll2 = Math.floor(Math.random() * selectedDice) + 1;
            if (advantage) {
              finalResult = Math.max(roll1, roll2);
              output = `<span class="result-roll lowlight-result">${roll1}</span> <span class="result-roll highlight-result">${roll2}</span>`;
            } else {
              finalResult = Math.min(roll1, roll2);
              output = `<span class="result-roll highlight-result">${roll1}</span> <span class="result-roll lowlight-result">${roll2}</span>`;
            }
          } else if (selectedDice === 100) {
            const tens = Math.floor(Math.random() * 10) * 10;
            const ones = Math.floor(Math.random() * 10);
            finalResult = tens + ones;
            if (finalResult === 0) finalResult = 100;
            output = `<span class="result-roll">${finalResult}</span>`;
          } else {
            finalResult = Math.floor(Math.random() * selectedDice) + 1;
            output = `<span class="result-roll">${finalResult}</span>`;
          }

          const rollResultEl = document.createElement('div');
          rollResultEl.innerHTML = `${diceIcons[selectedDice]}: ${output}`;
          resultsEl.appendChild(rollResultEl);
        }
      }, 1000);
    });

    function init() {
      // stats grid
      $('#stats').innerHTML = BASE_STATS.map(k=>`
        <div class="stat-cost">
          <h3>${k}</h3>
          <input id="stat_${k}" type="number" min="8" max="15" value="8" />
          <div class="stat-cost-controls">
            <button class="btn secondary" onclick="updateStat('${k}', -1)">-</button>
            <button class="btn secondary" onclick="updateStat('${k}', 1)">+</button>
          </div>
          <div class="muted">mod: <span class="mono" id="mod_${k}">0</span></div>
        </div>
      `).join('');

      fillSelect($('#species'), SPECIES, s=>s.key, s=>s.key);
      fillSelect($('#clazz'), CLASSES, c=>c.key, c=>c.key);
      
      $('#species').addEventListener('change', updateAll);
      $('#clazz').addEventListener('change', updateAll);
      $('#level').addEventListener('input', updateAll);
      $('#weapon').addEventListener('change', updateAll);
      $('#armor').addEventListener('change', updateAll);
      $('#utilA').addEventListener('change', updateAll);
      $('#utilB').addEventListener('change', updateAll);
      $('#toggleNamedArmor').addEventListener('change', updateAll);
      $('#hasShield').addEventListener('change', updateAll);
      $('#name').addEventListener('input', updateAll);
      BASE_STATS.forEach(k=>{$(`#stat_${k}`).addEventListener('input', updateAll)});

      $('#profile-pic-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            $('#profile-pic-preview').src = e.target.result;
            $('#profile-pic-preview').style.display = 'block';
            $('#profile-pic-frame').style.backgroundImage = 'none';
            updateAll();
          };
          reader.readAsDataURL(file);
        }
      });

      $('#btnExport').addEventListener('click', exportJSON);
      $('#btnPrint').addEventListener('click', ()=>window.print());

      load();
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
